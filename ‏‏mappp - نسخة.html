<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genetic Mutations Tree</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }
        #tree {
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #ffffff;
            overflow: hidden;
        }
        svg {
            font: 12px sans-serif;
        }
        .node rect {
            fill: #3498db;
            stroke: #2c3e50;
            stroke-width: 2px;
            transition: fill 0.3s ease;
        }
        .node rect:hover {
            fill: #2ecc71;
        }
        .node text.count {
            font-size: 12px;
            fill: #ffffff;
            text-anchor: middle;
            dominant-baseline: middle;
        }
        .node text.name {
            font-size: 10px;
            fill: #000000;
            text-anchor: middle;
            dominant-baseline: hanging;
        }
        .link {
            stroke: #95a5a6;
            stroke-width: 2px;
        }
        .node:hover text.count {
            fill: #e74c3c;
        }
        .node {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="tree"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            Papa.parse('https://docs.google.com/spreadsheets/d/e/2PACX-1vRnDqmeMrSFgOBL5MHbulxNw7F9PO4PZBFXtBqEyPmiljTZWQCTwakxKiRneckhvknl-jpvOeR7PuJT/pub?output=csv', {
                download: true,
                header: true,
                complete: function(results) {
                    const data = results.data;
                    const treeData = buildTreeData(data);
                    drawTree(treeData);
                },
                error: function(error) {
                    console.error('Error loading CSV data:', error);
                }
            });

            function buildTreeData(data) {
                let tree = { name: 'j', children: [], count: 0 };
                let nodes = { 'j': tree };
                let mutationCounts = {};

                data.forEach(row => {
                    if (!row['mutationInfo']) return;
                    const mutations = row['mutationInfo'].split('>').filter(Boolean);
                    let currentNode = nodes['j'];

                    mutations.forEach((mutation, index) => {
                        if (!nodes[mutation]) {
                            nodes[mutation] = { name: mutation, children: [], samples: [], count: 0 };
                            currentNode.children.push(nodes[mutation]);
                        }
                        currentNode = nodes[mutation];
                        if (index === mutations.length - 1) {
                            mutationCounts[mutation] = (mutationCounts[mutation] || 0) + 1;
                        }
                    });
                    currentNode.samples.push({ name: row['personInfo'], location: row['locationInfo'] });
                });

                Object.keys(nodes).forEach(key => {
                    if (mutationCounts[key]) {
                        nodes[key].count = mutationCounts[key];
                    }
                });

                return tree;
            }

            function drawTree(treeData) {
                const width = window.innerWidth;
                const height = window.innerHeight;
                const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svg.setAttribute("width", width);
                svg.setAttribute("height", height);
                document.getElementById("tree").appendChild(svg);

                function createTree(root, x, y, xOffset, level = 0) {
                    const children = root.children;
                    const nodeWidth = 100;
                    const nodeHeight = 50;
                    const verticalSpacing = 150;
                    const horizontalSpacing = 200;

                    // Draw node
                    const nodeGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
                    nodeGroup.setAttribute("transform", `translate(${x}, ${y})`);

                    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect.setAttribute("x", -nodeWidth / 2);
                    rect.setAttribute("y", -nodeHeight / 2);
                    rect.setAttribute("width", nodeWidth);
                    rect.setAttribute("height", nodeHeight);
                    rect.setAttribute("class", "node");
                    nodeGroup.appendChild(rect);

                    const nameText = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    nameText.setAttribute("class", "name");
                    nameText.setAttribute("x", 0);
                    nameText.setAttribute("y", -nodeHeight / 2 + 5);
                    nameText.textContent = root.name;
                    nodeGroup.appendChild(nameText);

                    const countText = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    countText.setAttribute("class", "count");
                    countText.setAttribute("x", 0);
                    countText.setAttribute("y", nodeHeight / 2 - 10);
                    countText.textContent = root.count || '';
                    nodeGroup.appendChild(countText);

                    svg.appendChild(nodeGroup);

                    // Draw links and child nodes
                    children.forEach((child, index) => {
                        const childX = x + (index - (children.length - 1) / 2) * horizontalSpacing;
                        const childY = y + verticalSpacing;

                        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                        line.setAttribute("class", "link");
                        line.setAttribute("x1", 0);
                        line.setAttribute("y1", nodeHeight / 2);
                        line.setAttribute("x2", childX - x);
                        line.setAttribute("y2", childY - y - nodeHeight / 2);
                        svg.appendChild(line);

                        createTree(child, childX, childY, xOffset / 2, level + 1);
                    });
                }

                createTree(treeData, width / 2, 100, width / 2);
            }
        });
    </script>
</body>
</html>
