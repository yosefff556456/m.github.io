<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simple Branch Diagram</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        .node {
            stroke: #000;
            stroke-width: 1.5px;
            fill: #fff;
        }
        .link {
            stroke: #999;
            stroke-width: 1.5px;
        }
        text {
            font-size: 12px;
            fill: #333;
        }
    </style>
</head>
<body>
    <svg width="1000" height="800"></svg>
    <script>
        // Fetch data from Google Sheets
        async function fetchData() {
            const response = await fetch('https://docs.google.com/spreadsheets/d/1JzhlaJTyZy9GSevl9UmaDcWdPRjv1yG7xnO-KhelUiM/export?format=csv&id=1JzhlaJTyZy9GSevl9UmaDcWdPRjv1yG7xnO-KhelUiM');
            const csvData = await response.text();
            return csvData;
        }

        // Convert CSV to JSON
        function csvToJson(csv) {
            const lines = csv.split('\n');
            const result = [];
            const headers = lines[0].split(',');

            for (let i = 1; i < lines.length; i++) {
                const obj = {};
                const currentLine = lines[i].split(',');

                for (let j = 0; j < headers.length; j++) {
                    obj[headers[j]] = currentLine[j];
                }

                if (obj[headers[0]]) result.push(obj);
            }

            return result;
        }

        // Create the hierarchical tree structure
        function createTree(data) {
            const tree = {};

            data.forEach(entry => {
                const path = entry.mutationInfo.split('>').filter(Boolean);
                let currentNode = tree;

                path.forEach(haplogroup => {
                    if (!currentNode[haplogroup]) {
                        currentNode[haplogroup] = {};
                    }
                    currentNode = currentNode[haplogroup];
                });
            });

            return tree;
        }

        // Transform tree into hierarchical format for D3
        function hierarchyData(node, name) {
            const children = Object.keys(node).map(key => hierarchyData(node[key], key));
            return {
                name,
                children: children.length ? children : undefined
            };
        }

        // Draw the tree using D3
        function drawTree(treeData) {
            const svg = d3.select('svg');
            const width = +svg.attr('width');
            const height = +svg.attr('height');

            const treeLayout = d3.tree().size([width - 160, height - 160]);
            const rootNode = d3.hierarchy(treeData);
            treeLayout(rootNode);

            // Add links
            svg.selectAll('.link')
                .data(rootNode.links())
                .enter()
                .append('line')
                .attr('class', 'link')
                .attr('x1', d => d.source.x + 80)
                .attr('y1', d => d.source.y + 80)
                .attr('x2', d => d.target.x + 80)
                .attr('y2', d => d.target.y + 80);

            // Add nodes
            const node = svg.selectAll('.node')
                .data(rootNode.descendants())
                .enter()
                .append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.x + 80},${d.y + 80})`);

            node.append('circle')
                .attr('r', 20);

            node.append('text')
                .attr('dy', 5)
                .attr('text-anchor', 'middle')
                .text(d => d.data.name);
        }

        // Main function to handle data and drawing
        async function main() {
            const csvData = await fetchData();
            const jsonData = csvToJson(csvData);
            const treeData = createTree(jsonData);
            const hierarchicalData = hierarchyData(treeData, 'Root');
            drawTree(hierarchicalData);
        }

        // Execute the main function
        main();
    </script>
</body>
</html>
